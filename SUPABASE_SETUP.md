# Supabase Storage ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì • ê°€ì´ë“œ

ì´ í”„ë¡œì íŠ¸ëŠ” ì´ë¯¸ì§€ íŒŒì¼ì„ Supabase Storageì— ì €ì¥í•©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ Supabaseë¥¼ ì„¤ì •í•˜ì„¸ìš”.

## 1. Supabase í”„ë¡œì íŠ¸ ìƒì„±

1. [Supabase](https://supabase.com/)ì— ê°€ì… ë° ë¡œê·¸ì¸
2. "New Project" í´ë¦­
3. í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥:
   - **Name**: í”„ë¡œì íŠ¸ ì´ë¦„ (ì˜ˆ: `toilet-map-app`)
   - **Database Password**: ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì €ì¥í•´ë‘ì„¸ìš”!)
   - **Region**: `Northeast Asia (Seoul)` ì„ íƒ (ê°€ì¥ ê°€ê¹Œìš´ ë¦¬ì „)
4. í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ (ì•½ 2ë¶„ ì†Œìš”)

## 2. Storage Bucket ìƒì„±

1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í”„ë¡œì íŠ¸ ì„ íƒ
2. ì™¼ìª½ ë©”ë‰´ì—ì„œ **Storage** í´ë¦­
3. "Create a new bucket" í´ë¦­
4. ë²„í‚· ì •ë³´ ì…ë ¥:
   - **Name**: `toilets` (ë˜ëŠ” ì›í•˜ëŠ” ì´ë¦„)
   - **Public bucket**: âœ… ì²´í¬ (ì´ë¯¸ì§€ë¥¼ ê³µê°œì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ)
5. "Create bucket" í´ë¦­

## 3. Storage ì •ì±… ì„¤ì • (Public ì½ê¸° í—ˆìš©)

1. ìƒì„±í•œ ë²„í‚· í´ë¦­
2. "Policies" íƒ­ìœ¼ë¡œ ì´ë™
3. "New Policy" í´ë¦­
4. "For full customization" ì„ íƒ
5. ì •ì±… ì´ë¦„: `Public Read Access`
6. ë‹¤ìŒ SQL ì…ë ¥:

```sql
-- Public ì½ê¸° ì •ì±…
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'toilets' );
```

7. "Review" â†’ "Save policy" í´ë¦­

## 4. Service Role Key ê°€ì ¸ì˜¤ê¸°

1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í”„ë¡œì íŠ¸ ì„ íƒ
2. ì™¼ìª½ ë©”ë‰´ì—ì„œ **Settings** â†’ **API** í´ë¦­
3. ë‹¤ìŒ ì •ë³´ ë³µì‚¬:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **service_role key**: `service_role` ì„¹ì…˜ì˜ `secret` í‚¤ (âš ï¸ ì ˆëŒ€ ê³µê°œí•˜ì§€ ë§ˆì„¸ìš”!)

## 5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`backend/.env` íŒŒì¼ì— ë‹¤ìŒ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:

```env
# Supabase ì„¤ì •
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
SUPABASE_STORAGE_BUCKET=toilets
```

> âš ï¸ **ë³´ì•ˆ ì£¼ì˜**: 
> - `SUPABASE_SERVICE_ROLE_KEY`ëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”
> - ì ˆëŒ€ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œë‚˜ ê³µê°œ ì €ì¥ì†Œì— ë…¸ì¶œí•˜ì§€ ë§ˆì„¸ìš”
> - `.env` íŒŒì¼ì€ `.gitignore`ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”

## 6. íŒ¨í‚¤ì§€ ì„¤ì¹˜

ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:

```bash
cd backend
npm install @supabase/supabase-js
```

## 7. í…ŒìŠ¤íŠ¸

1. ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰: `npm run dev`
2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í™”ì¥ì‹¤ ë“±ë¡ ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
3. Supabase ëŒ€ì‹œë³´ë“œì˜ Storageì—ì„œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ í™•ì¸

## ë¬¸ì œ í•´ê²°

### ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•ŠëŠ” ê²½ìš°

1. í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
2. Service Role Keyê°€ ì •í™•í•œì§€ í™•ì¸ (anon keyê°€ ì•„ë‹Œ service_role key ì‚¬ìš©)
3. ë²„í‚· ì´ë¦„ì´ ì •í™•í•œì§€ í™•ì¸ (`SUPABASE_STORAGE_BUCKET`)
4. ë²„í‚·ì´ Publicìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
5. Storage ì •ì±…ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
6. ë°±ì—”ë“œ ì½˜ì†” ë¡œê·¸ í™•ì¸

### ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ” ê²½ìš°

1. ë²„í‚·ì´ Publicìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
2. Storage ì •ì±…ì—ì„œ SELECT ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
3. ì´ë¯¸ì§€ URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ Network íƒ­)
4. CORS ì„¤ì • í™•ì¸ (SupabaseëŠ” ê¸°ë³¸ì ìœ¼ë¡œ CORS í—ˆìš©)

### "new row violates row-level security policy" ì˜¤ë¥˜

- Storage ì •ì±…ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ìœ„ì˜ "Storage ì •ì±… ì„¤ì •" ë‹¨ê³„ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”

## ë³´ì•ˆ ê¶Œì¥ì‚¬í•­

1. **Service Role Key ë³´í˜¸**: 
   - ì ˆëŒ€ í”„ë¡ íŠ¸ì—”ë“œì— ë…¸ì¶œí•˜ì§€ ë§ˆì„¸ìš”
   - í™˜ê²½ ë³€ìˆ˜ë¡œë§Œ ê´€ë¦¬í•˜ì„¸ìš”
   - Gitì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”

2. **Storage ì •ì±… ìµœì í™”**:
   - ì½ê¸°ëŠ” Publicìœ¼ë¡œ í—ˆìš©
   - ì“°ê¸°ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ í—ˆìš©í•˜ë„ë¡ ì •ì±… ì„¤ì • ê°€ëŠ¥

3. **íŒŒì¼ í¬ê¸° ì œí•œ**:
   - í˜„ì¬ 5MBë¡œ ì œí•œë˜ì–´ ìˆìŒ (multer ì„¤ì •)
   - í•„ìš”ì‹œ `backend/src/middleware/upload.ts`ì—ì„œ ì¡°ì • ê°€ëŠ¥

4. **íŒŒì¼ íƒ€ì… ê²€ì¦**:
   - ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš© (ì´ë¯¸ êµ¬í˜„ë¨)
   - í•„ìš”ì‹œ ì¶”ê°€ ê²€ì¦ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥

## ë¹„ìš© ê´€ë¦¬

Supabase ë¬´ë£Œ í”Œëœ:
- **Storage**: 1GB ë¬´ë£Œ
- **Bandwidth**: 2GB/ì›” ë¬´ë£Œ
- **File Uploads**: ë¬´ì œí•œ

> ğŸ’¡ **íŒ**: 
> - ë¬´ë£Œ í”Œëœìœ¼ë¡œë„ ì†Œê·œëª¨ í”„ë¡œì íŠ¸ëŠ” ì¶©ë¶„í•©ë‹ˆë‹¤
> - ì‚¬ìš©ëŸ‰ì´ ë§ì•„ì§€ë©´ Pro í”Œëœ ($25/ì›”)ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥
> - Storageì—ì„œ ì˜¤ë˜ëœ íŒŒì¼ì„ ì •ê¸°ì ìœ¼ë¡œ ì •ë¦¬í•˜ì—¬ ìš©ëŸ‰ ê´€ë¦¬

## ì¶”ê°€ ê¸°ëŠ¥

### ì´ë¯¸ì§€ ì‚­ì œ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)

í•„ìš”ì‹œ ì´ë¯¸ì§€ ì‚­ì œ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```typescript
// backend/src/services/supabaseService.tsì— ì¶”ê°€
export async function deleteImageFromSupabase(filePath: string): Promise<void> {
  const { error } = await supabase.storage
    .from(BUCKET_NAME)
    .remove([filePath]);
  
  if (error) {
    throw new Error(`ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
  }
}
```

### ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (ì„ íƒì‚¬í•­)

Supabase StorageëŠ” ì´ë¯¸ì§€ ë³€í™˜ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤:
- URLì— `?width=800&height=600` ì¶”ê°€í•˜ì—¬ ë¦¬ì‚¬ì´ì§• ê°€ëŠ¥
- ìì„¸í•œ ë‚´ìš©ì€ [Supabase Storage ë¬¸ì„œ](https://supabase.com/docs/guides/storage) ì°¸ê³ 

